<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
	<head>
		<meta charset="UTF-8">
		<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.bundle.min.js"></script>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
		<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
		<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
		<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
		<link rel="icon" href="../static/images/icon2.ico"/>
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<title>Noise sensor monitor</title>
		<style>
			footer {
				border-top: 1px solid #DADADA;
				height: 64px;
				line-height: 64px;
				font-size: 18px;
				color: #333;
				padding: 15px 0;
			}
			.logo {
				height: 50px;
				margin-bottom: 20px;
			}
		
			footer .giticon {
				text-align: right;
			}
			
			footer .fab {
				font-size: 36px;
				color: #666;
			}
			
			footer .fab:hover {
				color: #000;
			}
			
			header {
				border-bottom: 1px solid #DADADA;
				padding: 30px 0;
			}
			
			header h1 {
				margin: 0;
				padding: 0;
			}
			
			#datepicker {
				width: 100%;
				margin-bottom: 15px;
				height: 38px;
				padding: 5px;
				border-radius: 5px;
				border: 1px solid #C8C8C8;
			}
			
			.columntitle {
				margin-bottom: 15px;
			}
			
			.form {
				border-bottom: 1px solid #DADADA;
				padding: 30px 0;
				background-color: #FAFAFA;
			}
			
			.graphs {
				padding: 30px 0 60px 0;
				min-height: 300px;
			}
			
			.graphs h3 {
				margin-bottom: 10px;
			}
			
			.graphs canvas {
				margin-bottom: 30px;
			}
			
			.sensorselectbox {
				height: 200px;
				background-color: #FFFFFF;
				border: 1px solid #DADADA;
				padding: 12px 15px;
				border-radius: 5px;
			}
			
			.form-check {
				margin-bottom: 2px;
			}
			
			.nosensors {
				display: none;
				text-align: center;
				margin-top: 45px;
				font-size: 24px;
				color: #999;
				font-style: italic;
			}
			
			.homebutton {
				margin-top: 12px;
				font-weight: 600;
			}
			
			.sensorselectbox label span {
				height: 12px;
				width: 12px;
				display: inline-block;
				margin-left: 10px;
				border:1px solid #999;
			}
			
			.sensorselectbox input {
				margin-right:5px;
			}
			
			@media (min-width: 768px) {
				.formcolumn-left {
					padding-right: 30px;
				}
				.formcolumn-right {
					padding-left: 30px;
				}
			}
		</style>
	</head>
	<body>
		<header>
			<div class="container">
				<a href="/"><img class="logo" src="../static/images/noisyIoP_logo.png"
                                 th:src="@{../static/images/noisyIoP_logo.png}" alt="noisyIoT"></a>
			   <h1>Noise sensor monitor</h1>
			   <div class="clearfix"></div>
			</div>
		</header>
		<div class="form">
		   <div class="container">
			  <div class="row">
				 <div class="formcolumn-left col-md-6">
					<h2 class="columntitle">Set interval</h2>
					<input type="text" id="datepicker" name="datetimes" />
					<div class="text-right">
					   <button type="button" class="btn btn-primary">Submit</button>
					</div>
				 </div>
				 <div class="formcolumn-right col-md-6">
					<h2 class="columntitle">
					   Select sensors to show
					</h2>
					<div id="sensorselectbox" class="sensorselectbox overflow-auto">
					</div>
				 </div>
			  </div>
		   </div>
		</div>
		<div class="graphs">
		   <div class="container">
		   <div id="chart-legends"></div>
			  <div id="s1">
				 <canvas id="canvas1" width="400" height="200"></canvas>
			  </div>
		   </div>
		</div>
		<footer>
		   <div class="container">
			  <div class="row">
				 <div class="col-sm-10">Â© Team Ethernet 2019</div>
				 <div class="col-sm-2 giticon"><a href="https://github.com/team-ethernet" title="Check out our github" target="_blank"><i class="fab fa-github"></i></a></div>
			  </div>
		   </div>
		</footer>
		
		<script th:inline="javascript">
			/*<![CDATA[*/
				var json = /*[[${NoiseData}]]*/ 'default';
			/*]]>*/
			
			const groupBy = key => array =>
    array.reduce((objectsByKeyValue, obj) => {
        const value = obj[key];
        objectsByKeyValue[value] = (objectsByKeyValue[value] || []).concat(obj);
        return objectsByKeyValue;
    }, {});

const groupById = groupBy('noiseSensorId');
var sortedarray = groupById(json);




function randomDate(start, end, startHour, endHour) {
    var date = new Date(+start + Math.random() * (end - start));
    var hour = startHour + Math.random() * (endHour - startHour) | 0;
    date.setHours(hour);
    return date;
}

var timeFormat = 'DD/MM/YYYY HH:mm:ss';

var dateArray = [];
var k;
for (k = 0; k < 20; k++) {
    dateArray.push(randomDate(new Date("2018-04-24 16:27"), new Date("2019-04-24 16:27"), 0, 23));
}
dateArray.sort(function(a, b) {
    return b > a ? -1 : b < a ? 1 : 0;
});
var config = {
    type: 'line',
    data: {
        datasets: []
    },
    options: {
        legendCallback: function(chart) {
            console.log(chart);
            var legendHtml = [];
            legendHtml.push('<table>');
            legendHtml.push('<tr>');
            for (var i = 0; i < chart.data.datasets.length; i++) {
                legendHtml.push('<div class="chart-legend" style="background-color:' + chart.data.datasets[i].backgroundColor + '"></div>');
                if (chart.data.datasets[i].label) {
                    legendHtml.push('<input id="' + chart.data.datasets[i].label + '" type="checkbox" class="' + chart.data.datasets[i].label + '" onclick="updateDataset(event, ' + '\'' + chart.legend.legendItems[i].datasetIndex + '\', \'' + chart.data.datasets[i].label + '\')"> <label for="' + chart.data.datasets[i].label + '">' + chart.data.datasets[i].label + '<span style="background-color: ' + chart.data.datasets[i].borderColor + '"></span></label>');
                }
            }
            return legendHtml.join("");
        },
        legend: {
            display: false
        },
        responsive: true,
        title: {
            display: false
        },
        scales: {
            xAxes: [{
                type: "time",
                time: {
                    format: timeFormat,
                    tooltipFormat: timeFormat
                },
                scaleLabel: {
                    display: true,
                    labelString: 'Time'
                }
            }],
            yAxes: [{
                scaleLabel: {
                    display: true,
                    labelString: 'dB'
                }
            }]
        }
    }
};

updateDataset = function(e, datasetIndex, checkboxclass) {
    var index = datasetIndex;
    var ci = e.view.chart;
    var meta = ci.getDatasetMeta(index);

    if ($("." + checkboxclass).is(":checked"))
        meta.hidden = false;
    else
        meta.hidden = null;

    ci.update();
};


function hashCode(str) {
    var hash = 0;
    for (var i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    return hash;
}


function intToRGB(i) {
    var c = (i & 0x00FFFFFF)
        .toString(16)
        .toUpperCase();

    return "00000".substring(0, 6 - c.length) + c;
}



for (var key in sortedarray) {
    var color = intToRGB(hashCode(key));
    var datasetdata = {
        label: key,
        data: [],
        fill: false,
        borderColor: '#' + color,
        lineTension: 0.2,
        hidden: true
    };
    var i;
    for (i = 0; i < sortedarray[key].length; i++) {
        datasetdata.data.push({
            x: moment(sortedarray[key][i].date).format(timeFormat),
            y: sortedarray[key][i].value
        });
    }
    config.data.datasets.push(datasetdata);
}


var ctx = document.getElementById("canvas1").getContext("2d");
chart = new Chart(ctx, config);
document.getElementById('sensorselectbox').innerHTML = chart.generateLegend();


$(function() {
    $('input[name="datetimes"]').daterangepicker({
        timePicker: true,
        timePicker24Hour: true,
        startDate: moment().subtract(7, 'd').format('YYYY-MM-DD HH:mm'),
        endDate: moment().add(7, 'd').format('YYYY-MM-DD HH:mm'),
        locale: {
            format: 'YYYY-MM-DD HH:mm'
        }
    });
});
		</script>
	</body>
</html>